> **АРХИВ — ВЫПОЛНЕН 2026-02-05.** Popup Maker заменён кастомным попапом 08.02.2026.

# Интеграция формы заявки с Битрикс24 CRM

> Дата: 2026-02-05

## Задача

Заменить плагин FormCraft 3 на лёгкую HTML-форму, которая отправляет заявки напрямую в Битрикс24 CRM как лиды. Убрать сохранение в БД WordPress и email-уведомления.

---

## Текущее состояние

- **Плагин:** FormCraft 3 (v3.8.24), путь `/wp-content/plugins/form/`
- **Форма:** ID 2, slug `ostavit-zayavku`
- **Попап:** Popup Maker, ID `pum-8502`
- **Кнопка:** «Получить КП» на карточках товаров (`#popmake-8502`)
- **Данные:** 115 заявок в `wp_formcraft_3_submissions`
- **Отправка:** AJAX → `admin-ajax.php` → БД + email
- **CRM:** Интеграции нет

---

## Решение

### Архитектура

```
Кнопка «Получить КП» → Popup Maker (без изменений)
         ↓
HTML-форма (Имя, Телефон +7 маска, Email опционально)
         ↓
JS отправка через AJAX → WordPress admin-ajax.php
         ↓
PHP-обработчик → HTTP POST crm.lead.add → Битрикс24
         ↓
Лид создан в CRM
```

### Поля формы

| Поле | Тип | Обязательное | Детали |
|---|---|---|---|
| Имя | text | Да | |
| Телефон | tel | Да | Маска `+7 (___) ___-__-__`, +7 предзаполнено |
| Email | email | Нет | |
| Товар | hidden | — | Название товара со страницы |
| URL | hidden | — | URL страницы товара |

### Маппинг полей → Битрикс24 лид

| Поле формы | Поле лида B24 | Тип |
|---|---|---|
| Имя | `NAME` | string |
| Телефон | `PHONE[0][VALUE]` | crm_multifield |
| Email | `EMAIL[0][VALUE]` | crm_multifield (если заполнен) |
| Товар | `TITLE` | string (заголовок лида) |
| URL страницы | `SOURCE_DESCRIPTION` | string |
| — | `SOURCE_ID` | `WEB` (константа) |
| — | `OPENED` | `Y` (доступен всем) |

---

## Шаги реализации

### 1. Бэкап FormCraft

- Скачать плагин `/wp-content/plugins/form/` через FTP
- Экспортировать таблицу `wp_formcraft_3_submissions` (115 заявок)

### 2. Создать файл интеграции

Файл: `bitrix24-lead-form.php` (будет подключён в `functions.php`)

Содержит:
- **HTML-форму** — через shortcode `[bitrix24_form]` или напрямую в попап
- **CSS** — стили формы, совместимые с темой Flatsome
- **JS** — маска телефона (+7), AJAX-отправка, валидация, сообщения успех/ошибка
- **PHP AJAX-обработчик** — валидация на сервере + HTTP POST в Битрикс24

### 3. Настройка Битрикс24

В панели Битрикс24:
- Приложения → Вебхуки → Входящий вебхук
- Права: `crm` (CRM)
- Получить URL вида: `https://PORTAL.bitrix24.ru/rest/USER_ID/WEBHOOK_KEY/`

### 4. Обновить попап Popup Maker

- Заменить шорткод FormCraft `[fc id='2']` на новую форму `[bitrix24_form]`
- Проверить отображение в попапе

### 5. Деактивировать FormCraft

- Деактивировать плагин в WP Admin → Плагины
- Не удалять файлы сразу (есть бэкап, но на всякий случай)

### 6. Тестирование

- Отправить тестовую заявку
- Проверить создание лида в Битрикс24
- Проверить маску телефона
- Проверить отправку без email
- Проверить передачу названия товара

---

## Конфигурация

```php
// В wp-config.php или в файле интеграции
define('BITRIX24_WEBHOOK_URL', 'https://PORTAL.bitrix24.ru/rest/USER_ID/WEBHOOK_KEY/');
```

Адрес портала и ключ вебхука — подставить после создания вебхука в Битрикс24.

---

## Что убираем

- Плагин FormCraft 3 (деактивация)
- CSS/JS файлы FormCraft (перестанут грузиться)
- Сохранение заявок в `wp_formcraft_3_submissions`
- Email-уведомления о заявках

## Что остаётся

- Popup Maker — без изменений
- Кнопки «Получить КП» — без изменений
- Дизайн попапа — воспроизводим стилями Flatsome

---

*Статус: Утверждён*
